{% load i18n %}
{% load static %}
{% load mathfilters %}
{% load dict_filters %}

<!-- Enhanced Product Card Template -->

<div class="product-card fixed-card-height"
    data-product-id="{{ product.pk }}"
    data-product-variant-id="{% if product.variants.first %}{{ product.variants.first.pk }}{% endif %}">
    {% with main_image=product.get_main_image hover_image=product.get_hover_image %}
    <div class="product-image-wrapper">
        <!-- Product Badges - Optimized for better visibility -->
        <div class="product-badges">
            {% if not product.is_in_stock %}
                <div class="product-badge outofstock-badge">
                    <span class="material-icons" aria-hidden="true">cancel</span>
                    <span>{% trans "Out" %}</span>
                </div>
            {% else %}
                {% if product.is_on_sale %}
                    <div class="product-badge sale-badge">
                        <i class="fas fa-tag"></i>
                        <span>{% trans "Sale" %}</span>
                        {% if product.get_discount_percentage %}
                            <small>-{{ product.get_discount_percentage }}%</small>
                        {% endif %}
                    </div>
                {% endif %}

                {% if product.is_best_seller %}
                    <div class="product-badge bestseller-badge">
                        <i class="fas fa-crown"></i>
                        <span>{% trans "Best" %}</span>
                    </div>
                {% endif %}

                {% if product.is_new_arrival %}
                    <div class="product-badge new-badge">
                        <i class="fas fa-sparkles"></i>
                        <span>{% trans "New" %}</span>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- Stock Indicator -->
        {% if product.is_in_stock %}
            {% if product.stock_quantity %}
                {% if product.stock_quantity <= 5 %}
                <div class="stock-indicator low-stock">
                    <span class="material-icons">inventory_2</span>
                    <span>{% trans "Only" %} {{ product.stock_quantity }} {% trans "left" %}</span>
                </div>
                {% endif %}
            {% endif %}
        {% endif %}

        <a href="{{ product.get_absolute_url }}" class="product-link">
            {% if main_image %}
                <img src="{{ main_image.image_resized.url }}"
                     alt="{{ product.name }}"
                     loading="lazy"
                     class="product-img main-img">
                <img src="{% if hover_image %}{{ hover_image.image_resized.url }}{% else %}{{ main_image.image_resized.url }}{% endif %}"
                     alt="{{ product.name }} - {% trans 'Alternate view' %}"
                     loading="lazy"
                     class="product-img hover-img">
            {% else %}
                <img src="https://placehold.co/400x400/e0e0e0/555555?text=No+Image"
                     alt="{% trans 'No Image' %}"
                     loading="lazy"
                     class="product-img main-img">
            {% endif %}
        </a>

        <!-- Quick Action Buttons -->
        <div class="product-quick-actions">
            <button type="button"
                class="action-btn wishlist-btn {% if product.id|stringformat:"s" in request.session.wishlist %}active in-wishlist{% endif %}"
                data-action="wishlist-toggle"
                data-product-id="{{ product.id }}"
                title="{% if product.id|stringformat:'s' in request.session.wishlist %}{% trans 'Remove from Wishlist' %}{% else %}{% trans 'Add to Wishlist' %}{% endif %}"
                aria-label="{% if product.id|stringformat:'s' in request.session.wishlist %}{% trans 'Remove from Wishlist' %}{% else %}{% trans 'Add to Wishlist' %}{% endif %}">
                <span class="material-icons">{% if product.id|stringformat:"s" in request.session.wishlist %}close{% else %}favorite_border{% endif %}</span>
            </button>

            <button type="button" class="action-btn cart-btn {% if product.is_in_cart %}active{% endif %}"
                    data-action="{% if product.is_in_cart %}cart-remove{% else %}cart-add{% endif %}"
                    data-product-id="{{ product.id }}"
                    data-item-id="{{ product.cart_item_id|default:'' }}"
                    title="{% if product.is_in_cart %}{% trans 'Remove from Cart' %}{% else %}{% trans 'Add to Cart' %}{% endif %}"
                    aria-label="{% if product.is_in_cart %}{% trans 'Remove from Cart' %}{% else %}{% trans 'Add to Cart' %}{% endif %}">
                <span class="cart-add-icon" style="display: {% if product.is_in_cart %}none{% else %}inline-block{% endif %};">
                    <span class="material-icons" aria-hidden="true">add_shopping_cart</span>
                </span>
                <span class="cart-remove-icon" style="display: {% if product.is_in_cart %}inline-block{% else %}none{% endif %};">
                    <span class="material-icons" aria-hidden="true">remove_shopping_cart</span>
                </span>
            </button>

            <a href="{{ product.get_absolute_url }}"
               class="action-btn view-btn"
               title="{% trans 'Quick View' %}"
               aria-label="{% trans 'Quick View' %}">
               <span class="material-icons">visibility</span>
            </a>
        </div>
    </div>
    {% endwith %}

    <!-- Product Content -->
    <div class="product-content">
        <!-- Product Title -->
        <h3 class="product-title">
            <a href="{{ product.get_absolute_url }}" class="product-title-link">
                {{ product.name }}
            </a>
        </h3>

        <!-- Available Colors -->
            {% with colors=product.get_available_colors %}
            {% if colors %}
            <div class="product-colors-preview">
                <span class="colors-label">
                    <span class="material-icons">palette</span>
                    {% trans "Colors" %}:
                </span>
                <div class="color-swatches">
                    {% for color in colors|slice:":5" %}
                    <span class="color-dot"
                          style="background-color: {{ color.hex_code }};"
                          title="{{ color.name }}"></span>
                    {% endfor %}
                    {% if colors|length > 5 %}
                    <span class="more-colors">+{{ colors|length|add:"-5" }}</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="product-colors-preview">
                <span class="colors-label">
                    <span class="material-icons">palette</span>
                    {% trans "Colors" %}:
                </span>
                <span class="text-muted">{% trans "Not specified" %}</span>
            </div>
            {% endif %}
            {% endwith %}

        <!-- Available Sizes -->
            {% with sizes=product.get_available_sizes %}
            {% if sizes %}
            <div class="product-sizes-preview">
                <span class="sizes-label">
                    <span class="material-icons">straighten</span>
                    {% trans "Sizes" %}:
                </span>
                <div class="size-tags">
                    {% for size in sizes|slice:":4" %}
                    <span class="size-tag">{{ size.name }}</span>
                    {% endfor %}
                    {% if sizes|length > 4 %}
                    <span class="more-sizes">+{{ sizes|length|add:"-4" }}</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="product-sizes-preview">
                <span class="sizes-label">
                    <span class="material-icons">straighten</span>
                    {% trans "Sizes" %}:
                </span>
                <span class="text-muted">{% trans "Not specified" %}</span>
            </div>
            {% endif %}
            {% endwith %}

        <!-- Product Rating -->
        {% if product.average_rating %}
        <div class="product-rating">
            <div class="stars">
                {% for i in "12345" %}
                    {% if forloop.counter <= product.average_rating %}
                        <span class="material-icons star filled">star</span>
                    {% else %}
                        <span class="material-icons star">star_border</span>
                    {% endif %}
                {% endfor %}
            </div>
            <span class="rating-text">{{ product.average_rating|floatformat:1 }}</span>
            <span class="rating-count">({{ product.review_count|default:"0" }})</span>
        </div>
        {% endif %}

        <!-- Price Section -->
        <div class="product-price-wrapper">
            {% if product.is_on_sale %}
                <div class="price-group">
                    <span class="current-price sale">
                        {% if currency == 'EGP' %}
                            {{ product.price_egp|floatformat:2 }} <span class="currency">EGP</span>
                        {% else %}
                            ${{ product.price_usd|floatformat:2 }}
                        {% endif %}
                    </span>
                    <span class="old-price">
                        {% if currency == 'EGP' %}
                            {{ product.price_egp_no_sale|floatformat:2 }}
                        {% else %}
                            ${{ product.price_usd_no_sale|floatformat:2 }}
                        {% endif %}
                    </span>
                </div>
                <span class="discount-badge">
                    -{{ product.get_discount_percentage }}%
                </span>
            {% else %}
                <span class="current-price">
                    {% if currency == 'EGP' %}
                        {{ product.price_egp_no_sale|floatformat:2 }} <span class="currency">EGP</span>
                    {% else %}
                        ${{ product.price_usd_no_sale|floatformat:2 }}
                    {% endif %}
                </span>
            {% endif %}
        </div>

        <!-- Availability Status -->
        <div class="availability-status">
            {% if product.is_in_stock %}
                <span class="status in-stock">
                    <span class="material-icons">check_circle</span>
                    {% trans "In Stock" %}
                </span>
            {% else %}
                <span class="status out-of-stock">
                    <span class="material-icons">cancel</span>
                    {% trans "Out of Stock" %}
                </span>
            {% endif %}
        </div>

        <!-- Vendor Info -->
            <div class="vendor-info-compact">
                <span class="material-icons">store</span>
                {% if product.vendor and product.vendor.store_name %}
                    <a href="{{ product.vendor.get_absolute_url }}" class="vendor-name" title="{{ product.vendor.store_name }}">{{ product.vendor.store_name|truncatewords:3 }}</a>
                {% else %}
                    <span class="vendor-name text-muted">{% trans "Not specified" %}</span>
                {% endif %}
            </div>
    </div>

    <!-- Toast Container -->
    <div class="local-toast-container"></div>
</div>
