{% load static i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_CODE in 'ar' %}rtl{% else %}ltr{% endif %}" class="no-js">
<head>
    <!-- Essential Meta Tags -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#000000">
    <meta name="color-scheme" content="light dark">

    <!-- SEO & Social Meta Tags -->
    <title>{% block title %}ğ“œğ“ğ“ğ“¡ğ“¨ - Premium Fashion & Lifestyle{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}Discover premium fashion and lifestyle products at Mnory. Quality guaranteed with fast delivery across Egypt.{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}fashion, lifestyle, premium, clothing, accessories, egypt, mnory{% endblock %}">
    <meta name="author" content="Mnory">
    <meta name="robots" content="index, follow">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{% block og_title %}ğ“œğ“ğ“ğ“¡ğ“¨ - Premium Fashion & Lifestyle{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Discover premium fashion and lifestyle products at Mnory{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% static 'images/logo-black.png' %}{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Mnory">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}ğ“œğ“ğ“ğ“¡ğ“¨ - Premium Fashion & Lifestyle{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}Discover premium fashion and lifestyle products at Mnory{% endblock %}">
    <meta name="twitter:image" content="{% static 'images/logo-black.png' %}">

    <!-- Favicon and Touch Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon-16x16.png' %}">
    <link rel="shortcut icon" href="{% static 'images/logo-black.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/logo-black.png' %}">
    <link rel="apple-touch-icon-precomposed" href="{% static 'images/logo-black.png' %}">
    <link rel="manifest" href="{% static 'manifest.json' %}">

    <!-- DNS Prefetch for Performance -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//ajax.googleapis.com">

    <!-- Preload Critical Resources -->
    <link rel="preload" href="{% static 'fonts/alarabiyaBoutros2020-Regular.woff2' %}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js" as="script">

    <!-- Font Preconnections -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- External CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">

    <!-- Alertify for Notifications -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css">

    <!-- Animate.css for Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- AOS (Animate On Scroll) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">

    <!-- Main Enhanced CSS -->
    {% comment %} <link rel="stylesheet" href="{% static 'css/main.css' %}"> {% endcomment %}
    <link rel="stylesheet" href="{% static 'css/combined.css' %}">

    <!-- Additional CSS Block -->
    {% block css %}{% endblock css %}

    <!-- Essential jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Mnory",
        "url": "{{ request.build_absolute_uri }}",
        "logo-black": "{% static 'images/logo-black.png' %}",
        "description": "Premium fashion and lifestyle products",
        "contactPoint": {
            "@type": "ContactPoint",
            "contactType": "customer service",
            "availableLanguage": ["Arabic", "English"]
        }
    }
    </script>
</head>
<body data-animations="true"
      class="loading"
      itemscope
      itemtype="https://schema.org/WebPage"
      data-current-url-name="{{ current_url_name }}"
      data-cart-count-url="{% url 'shop:get_cart_and_wishlist_counts' %}"
      data-add-to-cart-url="{% url 'shop:add_to_cart' %}"
      data-remove-from-cart-url="{% url 'shop:remove_from_cart' %}"
      data-add-to-wishlist-url="{% url 'shop:add_to_wishlist' %}"
      data-remove-from-wishlist-url="{% url 'shop:remove_from_wishlist' %}"
      data-mark-notifications-url="{% url 'shop:mark_notifications_as_read' %}">

    <!-- Skip Link -->
    <a href="#main-content" class="skip-to-content visually-hidden-focusable">
        {% if LANGUAGE_CODE == 'ar' %}ØªØ®Ø·ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ{% else %}Skip to main content{% endif %}
    </a>

    <!-- Header -->
    <header role="banner" class="site-header">
        {% include 'partials/_header.html' %}
    </header>

    <!-- Page Loader -->
    <div class="page-loader" id="pageLoader">
        {% include 'partials/_loader.html' %}
    </div>

    <!-- Messages -->
    <section class="messages-container" role="alert" aria-live="polite">
        {% include 'partials/_messages.html' %}
        {% include "partials/_toast.html" %}
    </section>

    <!-- Hidden CSRF form to ensure CSRF cookie is set -->
    <form style="display: none;" aria-hidden="true">
        {% csrf_token %}
    </form>

    <!-- Main Content -->
    <main id="main-content" role="main" class="main-content bg-theme" itemscope itemtype="https://schema.org/WebPageElement">
        <div class="content-wrapper">
            {% block content %}
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-12 col-md-8 text-center">
                        <div class="welcome-section fade-in">
                            <h1 class="display-4 mb-4 text-theme fw-bold">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ğ“œğ“ğ“ğ“¡ğ“¨</h1>
                            <p class="lead text-theme-muted">Ø§ÙƒØªØ´Ù Ø£Ø­Ø¯Ø« ØµÙŠØ­Ø§Øª Ø§Ù„Ù…ÙˆØ¶Ø© ÙˆØ§Ù„Ø£Ù†Ø§Ù‚Ø©</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer role="contentinfo" class="footer">
        {% include 'partials/_footer.html' %}
    </footer>

    <!-- WhatsApp Widget -->
    <aside class="chat-widget-container" role="complementary">
        {% include 'partials/_whatsapp.html' %}
    </aside>

    <!-- Mnory Chatbot Widget -->
    <div id="mnoryChatbotWrapper" aria-live="polite" aria-label="{% if LANGUAGE_CODE == 'ar' %}Ù…Ø³Ø§Ø¹Ø¯ Ù…Ù†ÙˆØ±ÙŠ{% else %}Mnory Assistant{% endif %}">
        <button
            id="mnoryChatbotToggle"
            type="button"
            class="back-to-top-btn chatbot-btn"
            aria-haspopup="dialog"
            aria-expanded="false"
            aria-controls="mnoryChatbotWindow"
            aria-label="{% if LANGUAGE_CODE == 'ar' %}Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©{% else %}Chat support{% endif %}">
            <span class="material-icons">chat</span>
            <span class="chatbot-badge">{% if LANGUAGE_CODE == 'ar' %}Ù…Ø±Ø­Ø¨Ø§{% else %}Hi{% endif %}</span>
        </button>

        <div
            id="mnoryChatbotWindow"
            class="mnory-chatbot-window"
            role="dialog"
            aria-modal="false"
            aria-labelledby="mnoryChatbotTitle"
            dir="{% if LANGUAGE_CODE == 'ar' %}rtl{% else %}ltr{% endif %}">
            <div class="mnory-chatbot-header">
                <div>
                    <div id="mnoryChatbotTitle" class="mnory-chatbot-title">
                        {% if LANGUAGE_CODE == 'ar' %}
                            Ù…Ø³Ø§Ø¹Ø¯ Ù…Ù†ÙˆØ±ÙŠ
                        {% else %}
                            Mnory Assistant
                        {% endif %}
                    </div>
                    <div class="mnory-chatbot-subtitle">
                        {% if LANGUAGE_CODE == 'ar' %}
                            Ø§Ø³Ø£Ù„ Ø¹Ù† Ù…Ù†ÙˆØ±ÙŠØŒ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø£Ùˆ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…
                        {% else %}
                            Ask about Mnory, privacy policy or terms
                        {% endif %}
                    </div>
                </div>
                <button type="button" id="mnoryChatbotClose" class="mnory-chatbot-close" aria-label="{% if LANGUAGE_CODE == 'ar' %}Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©{% else %}Close chat{% endif %}">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div
                id="mnoryChatbotSuggestions"
                class="mnory-chatbot-suggestions">
                <div class="mnory-chatbot-suggestions-label">
                    {% if LANGUAGE_CODE == 'ar' %}
                        Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚ØªØ±Ø­Ø©
                    {% else %}
                        Suggested questions
                    {% endif %}
                </div>
                <div class="mnory-chatbot-suggestions-list">
                    {% if LANGUAGE_CODE == 'ar' %}
                        <button type="button" class="mnory-chatbot-suggestion" data-question="ÙƒÙŠÙ ØªØ­Ù…ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§ØªÙŠØŸ">
                            ÙƒÙŠÙ ØªØ­Ù…ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§ØªÙŠØŸ
                        </button>
                        <button type="button" class="mnory-chatbot-suggestion" data-question="Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…ØŸ">
                            Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…ØŸ
                        </button>
                        <button type="button" class="mnory-chatbot-suggestion" data-question="Ù…Ù† Ù‡Ùˆ Ù…Ù†ÙˆØ±ÙŠØŸ">
                            Ù…Ù† Ù‡Ùˆ Ù…Ù†ÙˆØ±ÙŠØŸ
                        </button>
                    {% else %}
                        <button type="button" class="mnory-chatbot-suggestion" data-question="How do you protect my data?">
                            How do you protect my data?
                        </button>
                        <button type="button" class="mnory-chatbot-suggestion" data-question="What are your terms and conditions?">
                            What are your terms and conditions?
                        </button>
                        <button type="button" class="mnory-chatbot-suggestion" data-question="What is Mnory?">
                            What is Mnory?
                        </button>
                    {% endif %}
                </div>
            </div>

            <div id="mnoryChatbotMessages" class="mnory-chatbot-messages">
            </div>

            <form id="mnoryChatbotForm" class="mnory-chatbot-form">
                <input
                    id="mnoryChatbotInput"
                    type="text"
                    name="question"
                    autocomplete="off"
                    placeholder="{% if LANGUAGE_CODE == 'ar' %}Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...{% else %}Type your question...{% endif %}"
                    class="mnory-chatbot-input">
                <button type="submit" class="mnory-chatbot-send">
                    {% if LANGUAGE_CODE == 'ar' %}Ø¥Ø±Ø³Ø§Ù„{% else %}Send{% endif %}
                </button>
            </form>
        </div>
        <!-- Chatbot Backdrop -->
        <div id="mnoryChatbotBackdrop" class="mnory-chatbot-backdrop"></div>
    </div>

    <div class="modal fade" id="compareModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Compare Products" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                </div>
                <div class="modal-body">
                    <div id="compareTableWrapper" class="table-responsive">
                        <table class="table table-striped align-middle compare-table"
                               data-label-name="{% trans 'Name' %}"
                               data-label-price="{% trans 'Price' %}"
                               data-label-vendor="{% trans 'Vendor' %}"
                               data-label-rating="{% trans 'Rating' %}"
                               data-label-colors="{% trans 'Colors' %}"
                               data-label-sizes="{% trans 'Sizes' %}"
                               data-label-availability="{% trans 'Availability' %}">
                            <thead>
                                <tr id="compareHeaderRow"></tr>
                            </thead>
                            <tbody id="compareBodyRows"></tbody>
                        </table>
                    </div>
                    <div id="compareEmptyState" class="text-center text-muted py-4" style="display: none;">
                        <span class="material-icons d-block mb-2">compare_arrows</span>
                        <p>{% trans "Select products to compare." %}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="compareClearBtn" class="btn btn-outline-secondary">
                        {% trans "Clear" %}
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        {% trans "Close" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Top -->
    <button id="backToTop" class="back-to-top-btn" aria-label="{% if LANGUAGE_CODE == 'ar' %}Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰{% else %}Back to top{% endif %}">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

    <!-- AOS (Animate On Scroll) -->
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
        // Initialize AOS if available
        if (typeof AOS !== 'undefined') {
            AOS.init({
                duration: 800,
                once: true,
                offset: 100
            });
        }
    </script>

    <!-- Cart & Wishlist Module -->
    <script src="{% static 'js/cart-wishlist.js' %}"></script>

    <!-- Main JS -->
    <script src="{% static 'js/main.js' %}"></script>

    <!-- Mnory Chatbot Logic -->
    <script>
        (function () {
            const toggleBtn = document.getElementById('mnoryChatbotToggle');
            const chatWindow = document.getElementById('mnoryChatbotWindow');
            const closeBtn = document.getElementById('mnoryChatbotClose');
            const backdrop = document.getElementById('mnoryChatbotBackdrop');
            const form = document.getElementById('mnoryChatbotForm');
            const input = document.getElementById('mnoryChatbotInput');
            const messages = document.getElementById('mnoryChatbotMessages');
            const suggestionsContainer = document.getElementById('mnoryChatbotSuggestions');
            const suggestionButtons = suggestionsContainer ? suggestionsContainer.querySelectorAll('[data-question]') : null;

            if (!toggleBtn || !chatWindow || !form || !input || !messages || !backdrop) {
                return;
            }

            const greetingText = `{% if LANGUAGE_CODE == 'ar' %}Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ù…Ù†ÙˆØ±ÙŠ. ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ ÙÙ‡Ù… Ù…Ù† Ù†Ø­Ù†ØŒ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©ØŒ Ø£Ùˆ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù….{% else %}Hi! I am the Mnory assistant. I can help you with information about Mnory, our privacy policy, and our terms of service.{% endif %}`;
            const errorText = `{% if LANGUAGE_CODE == 'ar' %}Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.{% else %}Something went wrong, please try again later.{% endif %}`;
            const emptyText = `{% if LANGUAGE_CODE == 'ar' %}Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹.{% else %}Please type a question first.{% endif %}`;

            function appendMessage(text, sender) {
                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '6px';
                wrapper.style.display = 'flex';
                wrapper.style.justifyContent = sender === 'user' ? 'flex-end' : 'flex-start';

                const bubble = document.createElement('div');
                bubble.textContent = text;
                bubble.style.maxWidth = '80%';
                bubble.style.padding = '6px 10px';
                bubble.style.borderRadius = '12px';
                bubble.style.fontSize = '0.83rem';
                bubble.style.lineHeight = '1.4';
                if (sender === 'user') {
                    bubble.style.background = 'var(--mnory-accent)';
                    bubble.style.color = '#fff';
                    if (document.documentElement.getAttribute('dir') === 'rtl') {
                        bubble.style.borderBottomLeftRadius = '2px';
                    } else {
                        bubble.style.borderBottomRightRadius = '2px';
                    }
                } else {
                    bubble.style.background = 'var(--theme-bg-secondary)';
                    bubble.style.color = 'var(--theme-text)';
                    if (document.documentElement.getAttribute('dir') === 'rtl') {
                        bubble.style.borderBottomRightRadius = '2px';
                    } else {
                        bubble.style.borderBottomLeftRadius = '2px';
                    }
                }

                wrapper.appendChild(bubble);
                messages.appendChild(wrapper);
                messages.scrollTop = messages.scrollHeight;
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');

            function sendQuestion(rawQuestion) {
                const question = (rawQuestion || '').trim();
                if (!question) {
                    appendMessage(emptyText, 'bot');
                    return;
                }

                appendMessage(question, 'user');
                input.value = '';

                const typingId = 'mnory-typing-indicator';
                const typing = document.createElement('div');
                typing.id = typingId;
                typing.style.marginBottom = '6px';
                typing.textContent = '...';
                typing.style.fontSize = '0.78rem';
                typing.style.opacity = '0.7';
                messages.appendChild(typing);
                messages.scrollTop = messages.scrollHeight;

                fetch("{% url 'shop:chatbot_api' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken || ''
                    },
                    body: JSON.stringify({ question: question })
                })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        const el = document.getElementById(typingId);
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                        if (data && data.success && data.answer) {
                            appendMessage(data.answer, 'bot');
                        } else if (data && data.error) {
                            appendMessage(data.error, 'bot');
                        } else {
                            appendMessage(errorText, 'bot');
                        }
                    })
                    .catch(function () {
                        const el = document.getElementById(typingId);
                        if (el && el.parentNode) {
                            el.parentNode.removeChild(el);
                        }
                        appendMessage(errorText, 'bot');
                    });
            }

            function openChat() {
                chatWindow.classList.remove('closing');
                chatWindow.classList.add('opening');
                chatWindow.style.display = 'flex';
                backdrop.classList.add('active');
                document.body.classList.add('chatbot-open');
                toggleBtn.setAttribute('aria-expanded', 'true');

                if (!messages.dataset.initialized) {
                    appendMessage(greetingText, 'bot');
                    messages.dataset.initialized = '1';
                }

                setTimeout(function() {
                    input.focus();
                }, 300);

                // Hide the badge after first interaction
                const badge = toggleBtn.querySelector('.chatbot-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
            }

            function closeChat() {
                chatWindow.classList.remove('opening');
                chatWindow.classList.add('closing');
                backdrop.classList.remove('active');
                document.body.classList.remove('chatbot-open');
                toggleBtn.setAttribute('aria-expanded', 'false');

                setTimeout(function() {
                    chatWindow.style.display = 'none';
                    chatWindow.classList.remove('closing');
                }, 300);
            }            toggleBtn.addEventListener('click', function () {
                if (chatWindow.style.display === 'flex') {
                    closeChat();
                } else {
                    openChat();
                }
            });

            const headerToggleBtn = document.getElementById('headerChatbotToggle');
            if (headerToggleBtn) {
                headerToggleBtn.addEventListener('click', function () {
                    if (chatWindow.style.display === 'flex') {
                        closeChat();
                    } else {
                        openChat();
                    }
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', closeChat);
            }

            // Close chatbot when clicking backdrop
            backdrop.addEventListener('click', closeChat);

            if (suggestionsContainer && suggestionButtons && suggestionButtons.length) {
                suggestionButtons.forEach(function (btn) {
                    btn.addEventListener('click', function () {
                        var q = btn.getAttribute('data-question') || '';
                        if (!q) {
                            return;
                        }
                        input.value = q;
                        sendQuestion(q);
                    });
                });
            }

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                sendQuestion(input.value || '');
            });
        })();
    </script>

    <!-- Page-Specific JS -->
    {% block js %}{% endblock js %}
</body>
</html>
