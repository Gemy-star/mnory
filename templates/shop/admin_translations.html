{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Translations" %} - Mnory Admin{% endblock %}

{% block content %}
<main class="category-detail-section">
    <div class="container py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="breadcrumb-nav mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'shop:home' %}"><span class="material-icons">home</span> {% trans "Home" %}</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'shop:admin_dashboard' %}">{% trans "Admin Dashboard" %}</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">{% trans "Translations" %}</li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="section-title mb-1">
                    <span class="material-icons">translate</span>
                    {% trans "Translations" %}
                </h1>
                <p class="text-muted mb-0">
                    {% blocktrans %}Manage your project translations using a simple inline editor powered by AJAX.{% endblocktrans %}
                </p>
            </div>
        </div>

        <div class="row g-4">
            <!-- Languages & PO files -->
            <div class="col-lg-4">
                <div class="account-card h-100">
                    <div class="account-card-header">
                        <h3 class="mb-0">{% trans "Translation files" %}</h3>
                    </div>
                    <div class="account-card-body">
                        <p id="translation-status-message" class="text-muted small mb-2"></p>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle" id="translation-status-table">
                                <thead>
                                <tr>
                                    <th>{% trans "Code" %}</th>
                                    <th>{% trans "Language" %}</th>
                                    <th>{% trans "PO files" %}</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <p class="text-muted small mb-0">
                            {% trans "Click a language to load its messages." %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Messages editor -->
            <div class="col-lg-8">
                <div class="account-card h-100">
                    <div class="account-card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">{% trans "Messages" %}</h3>
                        <div class="d-flex align-items-center gap-2">
                            <label for="translation-filter-input" class="form-label mb-0 small">{% trans "Filter" %}</label>
                            <input type="text" id="translation-filter-input" class="form-control form-control-sm" style="min-width: 220px;" placeholder="{% trans 'Search by ID or translation' %}">
                        </div>
                    </div>
                    <div class="account-card-body">
                        <p id="translation-editor-message" class="text-muted small mb-2"></p>
                        <div class="table-responsive" style="max-height: 480px; overflow-y: auto;">
                            <table class="table table-sm align-middle" id="translation-messages-table">
                                <thead>
                                <tr>
                                    <th style="width: 45%;">{% trans "Message ID" %}</th>
                                    <th>{% trans "Translation" %}</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end mt-3">
                            <button type="button" class="btn btn-primary" id="translation-save-button">
                                <span class="material-icons" style="font-size: 18px; margin-right: 4px;">save</span>
                                {% trans "Save translations" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    #translation-status-table tbody tr.selected {
        background-color: rgba(102, 126, 234, 0.08);
    }
    #translation-messages-table textarea {
        width: 100%;
        font-size: 0.85rem;
        resize: vertical;
    }
</style>

<script>
(function() {
  var currentLangCode = null;
  var allMessages = [];

  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function renderTranslations(payload) {
    var msg = document.getElementById('translation-status-message');
    var table = document.getElementById('translation-status-table');
    var tbody = table.querySelector('tbody');

    tbody.innerHTML = '';
    msg.textContent = '';

    if (!payload || !payload.languages || !payload.languages.length) {
      msg.textContent = '{% trans "No translation data found." %}';
      return;
    }

    payload.languages.forEach(function(lang) {
      var tr = document.createElement('tr');

      var tdCode = document.createElement('td');
      tdCode.textContent = lang.code || '';
      tr.appendChild(tdCode);

      var tdName = document.createElement('td');
      tdName.textContent = lang.name || '';
      tr.appendChild(tdName);

      var tdPo = document.createElement('td');
      if (lang.po_count && lang.po_count > 0) {
        tdPo.textContent = (lang.po_count + ' *.po');
      } else {
        tdPo.textContent = '-';
      }
      tr.appendChild(tdPo);

      tr.setAttribute('data-lang-code', lang.code || '');
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', function() {
        if (!lang.code) return;
        selectLanguageRow(lang.code, tr);
      });

      tbody.appendChild(tr);
    });
  }

  function loadTranslations() {
    var msg = document.getElementById('translation-status-message');
    msg.textContent = '{% trans "Loading translation data..." %}';

    fetch('/admin/api/translations/')
      .then(function(resp) { return resp.json(); })
      .then(function(data) { renderTranslations(data); })
      .catch(function(err) {
        console.error(err);
        msg.textContent = '{% trans "Failed to load translation data." %}';
      });
  }

  function renderMessagesTable(messages) {
    var table = document.getElementById('translation-messages-table');
    var tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    if (!messages || !messages.length) {
      return;
    }

    messages.forEach(function(msg) {
      var tr = document.createElement('tr');

      var tdId = document.createElement('td');
      tdId.textContent = msg.msgid || '';
      tr.appendChild(tdId);

      var tdStr = document.createElement('td');
      var textarea = document.createElement('textarea');
      textarea.rows = 2;
      textarea.value = msg.msgstr || '';
      textarea.setAttribute('data-msgid', msg.msgid || '');
      tdStr.appendChild(textarea);
      tr.appendChild(tdStr);

      tbody.appendChild(tr);
    });
  }

  function selectLanguageRow(langCode, row) {
    currentLangCode = langCode;
    var editorMsg = document.getElementById('translation-editor-message');
    editorMsg.textContent = '{% trans "Loading messages for" %} ' + langCode + '...';

    var rows = document.querySelectorAll('#translation-status-table tbody tr');
    rows.forEach(function(r) { r.classList.remove('selected'); });
    if (row) {
      row.classList.add('selected');
    }

    fetch('/admin/api/translations/' + encodeURIComponent(langCode) + '/')
      .then(function(resp) { return resp.json(); })
      .then(function(data) {
        allMessages = data.messages || [];
        renderMessagesTable(allMessages);
        editorMsg.textContent = '{% trans "Loaded" %} ' + allMessages.length + ' {% trans "messages" %}.';
      })
      .catch(function(err) {
        console.error(err);
        editorMsg.textContent = '{% trans "Failed to load messages." %}';
      });
  }

  function applyFilter() {
    var input = document.getElementById('translation-filter-input');
    var q = (input.value || '').toLowerCase();
    if (!q) {
      renderMessagesTable(allMessages);
      return;
    }
    var filtered = allMessages.filter(function(m) {
      var id = (m.msgid || '').toLowerCase();
      var val = (m.msgstr || '').toLowerCase();
      return id.indexOf(q) !== -1 || val.indexOf(q) !== -1;
    });
    renderMessagesTable(filtered);
  }

  function handleSave() {
    var editorMsg = document.getElementById('translation-editor-message');
    if (!currentLangCode) {
      editorMsg.textContent = '{% trans "Select a language first." %}';
      return;
    }

    var inputs = document.querySelectorAll('#translation-messages-table [data-msgid]');
    var messages = [];
    inputs.forEach(function(input) {
      var msgid = input.getAttribute('data-msgid');
      if (!msgid) return;
      messages.push({ msgid: msgid, msgstr: input.value || '' });
    });

    editorMsg.textContent = '{% trans "Saving translations..." %}';

    fetch('/admin/api/translations/' + encodeURIComponent(currentLangCode) + '/update/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ messages: messages })
    })
      .then(function(resp) { return resp.json(); })
      .then(function(data) {
        if (data.errors && Object.keys(data.errors).length) {
          console.error('Translation save errors', data.errors);
          editorMsg.textContent = '{% trans "Some translations failed to save." %}';
        } else {
          editorMsg.textContent = '{% trans "Translations saved successfully." %}';
        }
      })
      .catch(function(err) {
        console.error(err);
        editorMsg.textContent = '{% trans "Failed to save translations." %}';
      });
  }

  document.addEventListener('DOMContentLoaded', function() {
    loadTranslations();
    var filterInput = document.getElementById('translation-filter-input');
    if (filterInput) {
      filterInput.addEventListener('input', applyFilter);
    }
    var saveBtn = document.getElementById('translation-save-button');
    if (saveBtn) {
      saveBtn.addEventListener('click', handleSave);
    }
  });
})();
</script>
{% endblock %}
