{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Shopping Cart" %}{% endblock %}

{% block content %}
<section class="modern-cart-section">
  <div class="container">

    <!-- Modern Cart Header with Animation -->
    <div class="modern-cart-header"
         data-aos="fade-down"
         data-aos-duration="800"
         data-aos-easing="ease-out-cubic">
      <div class="cart-header-content">
        <div class="cart-icon-wrapper">
          <span class="material-icons cart-icon">shopping_cart</span>
          <span class="cart-badge" id="cart-items-badge">{{ items|length }}</span>
        </div>
        <h1 class="cart-title">{% trans "Shopping Cart" %}</h1>
        <p class="cart-subtitle">{% trans "Review and manage your selected items" %}</p>
      </div>
      <div class="cart-divider"></div>
    </div>

    {% if items %}
    <div class="modern-cart-container" id="cart-items-container">

      <!-- Cart Items Grid -->
      <div class="cart-items-wrapper">
        <div class="cart-items-grid">
          {% for item in items %}
          <div class="modern-cart-item cart-item"
               data-item-id="{{ item.id }}"
               data-aos="zoom-in-up"
               data-aos-delay="{{ forloop.counter|add:'0'|add:'0' }}"
               data-aos-duration="600"
               data-aos-easing="ease-out-back">

            <div class="cart-item-horizontal-layout">
              <!-- Product Card -->
              <div class="cart-item-card">
                {% include "partials/_product.html" with product=item.variant.product section="cart" %}
              </div>

              <!-- Item Details with Modern Design -->
              <div class="cart-item-info">
                <div class="item-specs">
                  <div class="spec-item" data-aos="fade-right" data-aos-delay="{{ forloop.counter|add:'1'|add:'0'|add:'0' }}">
                    <span class="spec-icon material-icons">palette</span>
                    <div class="spec-content">
                      <span class="spec-label">{% trans "Color" %}</span>
                      <span class="spec-value">{{ item.variant.color.name }}</span>
                    </div>
                  </div>

                  <div class="spec-item" data-aos="fade-right" data-aos-delay="{{ forloop.counter|add:'1'|add:'5'|add:'0' }}">
                    <span class="spec-icon material-icons">straighten</span>
                    <div class="spec-content">
                      <span class="spec-label">{% trans "Size" %}</span>
                      <span class="spec-value">{{ item.variant.size.name }}</span>
                    </div>
                  </div>

                  <div class="spec-item" data-aos="fade-right" data-aos-delay="{{ forloop.counter|add:'2'|add:'0'|add:'0' }}">
                    <span class="spec-icon material-icons">numbers</span>
                    <div class="spec-content">
                      <span class="spec-label">{% trans "Quantity" %}</span>
                      <span class="spec-value">{{ item.quantity }}</span>
                    </div>
                  </div>

                  <div class="spec-item spec-item-total" data-aos="fade-right" data-aos-delay="{{ forloop.counter|add:'2'|add:'5'|add:'0' }}">
                    <span class="spec-icon material-icons">payments</span>
                    <div class="spec-content">
                      <span class="spec-label">{% trans "Total" %}</span>
                      <span class="spec-value-price">{{ item.total|floatformat:2 }}</span>
                    </div>
                  </div>
                </div>

                <!-- Remove Button with Modern Style -->
                <button class="modern-remove-btn remove-from-cart"
                        data-id="{{ item.id }}"
                        data-aos="fade-up"
                        data-aos-delay="{{ forloop.counter|add:'3'|add:'0'|add:'0' }}"
                        title="{% trans 'Remove from cart' %}">
                  <span class="material-icons">delete_outline</span>
                  <span class="btn-text">{% trans "Remove" %}</span>
                </button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Modern Order Summary -->
      <div class="cart-summary-wrapper">
        <div class="modern-order-summary sticky-summary"
             data-aos="fade-left"
             data-aos-duration="800"
             data-aos-delay="200">

          <div class="summary-header">
            <span class="material-icons summary-icon">receipt_long</span>
            <h3 class="summary-title">{% trans "Order Summary" %}</h3>
          </div>

          <div class="summary-body">
            <div class="summary-line"
                 data-aos="fade-left"
                 data-aos-delay="300">
              <span class="summary-label">{% trans "Subtotal" %}</span>
              <span class="summary-value" id="cart-subtotal">{{ total|floatformat:2 }}</span>
            </div>

            <div class="summary-line"
                 data-aos="fade-left"
                 data-aos-delay="350">
              <span class="summary-label">
                <span class="material-icons label-icon">local_shipping</span>
                {% trans "Shipping" %}
              </span>
              <span class="summary-value" id="cart-shipping">{{ shipping_fee|floatformat:2 }}</span>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-line summary-total"
                 data-aos="fade-left"
                 data-aos-delay="400">
              <span class="summary-label-total">{% trans "Total" %}</span>
              <span class="summary-value-total" id="cart-total">{{ grand_total|floatformat:2 }}</span>
            </div>
          </div>

          <div class="summary-footer">
            <a href="{% url 'shop:checkout' %}"
               class="modern-checkout-btn"
               data-aos="zoom-in"
               data-aos-delay="500">
              <span class="btn-text">{% trans "Proceed to Checkout" %}</span>
              <span class="material-icons btn-icon">arrow_forward</span>
            </a>

            <a href="{% url 'shop:home' %}"
               class="continue-shopping-link"
               data-aos="fade-up"
               data-aos-delay="600">
              <span class="material-icons">arrow_back</span>
              {% trans "Continue Shopping" %}
            </a>
          </div>
        </div>
      </div>

    </div>

    {% else %}
    <div class="empty-cart-container"
         id="empty-cart-message"
         data-aos="zoom-in"
         data-aos-duration="800">
      <div class="empty-cart-icon-wrapper">
        <span class="material-icons empty-cart-icon">shopping_cart</span>
      </div>
      <h3 class="empty-cart-title">{% trans "Your cart is empty" %}</h3>
      <p class="empty-cart-text">{% trans "Start adding items to your cart to see them here." %}</p>
      <a href="{% url 'shop:home' %}" class="empty-cart-btn">
        <span class="material-icons">storefront</span>
        {% trans "Browse Products" %}
      </a>
    </div>
    {% endif %}

  </div>
</section>
{% endblock %}

{% block js %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Initialize AOS
  AOS.init({
    duration: 800,
    easing: 'ease-out-cubic',
    once: false,
    mirror: true,
    offset: 50
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Event delegation for dynamically updated cart items with animations
  const cartContainer = document.getElementById('cart-items-container');
  if (cartContainer) {
    cartContainer.addEventListener('click', function(e) {
      if (e.target.closest('.remove-from-cart')) {
        e.preventDefault();
        const btn = e.target.closest('.remove-from-cart');
        const itemId = btn.dataset.id;
        const cartItemElem = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);

        alertify.confirm(
          '{% trans "Confirm Deletion" %}',
          '{% trans "Are you sure you want to remove this item?" %}',
          function() {
            // Add removing animation
            if (cartItemElem) {
              cartItemElem.style.animation = 'cartItemRemove 0.5s ease-out forwards';
            }

            setTimeout(() => {
              fetch("{% url 'shop:remove_from_cart' %}", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": csrftoken,
                  "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ cart_item_id: itemId })
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  alertify.success('{% trans "Item removed from cart." %}');
                  if (cartItemElem) cartItemElem.remove();

                  // Update totals with animation
                  if (data.cart_total_items !== undefined) {
                    const cartCountElem = document.getElementById('cart-count');
                    const cartBadge = document.getElementById('cart-items-badge');
                    if (cartCountElem) {
                      cartCountElem.style.animation = 'pulse 0.5s ease';
                      cartCountElem.textContent = data.cart_total_items;
                    }
                    if (cartBadge) {
                      cartBadge.style.animation = 'pulse 0.5s ease';
                      cartBadge.textContent = data.cart_total_items;
                    }
                  }

                  if (data.cart_total_price !== undefined) {
                    const subtotalElem = document.getElementById('cart-subtotal');
                    const totalElem = document.getElementById('cart-total');
                    if (subtotalElem) {
                      subtotalElem.style.animation = 'numberUpdate 0.5s ease';
                      subtotalElem.textContent = parseFloat(data.cart_total_price).toFixed(2);
                    }
                    if (totalElem) {
                      totalElem.style.animation = 'numberUpdate 0.5s ease';
                      totalElem.textContent = parseFloat(data.cart_total_price).toFixed(2);
                    }
                  }

                  // If no items left, show empty message with animation
                  if (data.cart_total_items === 0) {
                    const cartItemsContainer = document.getElementById('cart-items-container');
                    if (cartItemsContainer) {
                      cartItemsContainer.style.animation = 'fadeOut 0.5s ease forwards';
                      setTimeout(() => {
                        cartItemsContainer.style.display = 'none';
                        const emptyMsg = document.getElementById('empty-cart-message');
                        if (emptyMsg) {
                          emptyMsg.style.display = 'flex';
                          emptyMsg.style.animation = 'fadeInScale 0.6s ease forwards';
                        }
                      }, 500);
                    }
                  }
                } else {
                  alertify.error(data.message || "{% trans 'Failed to remove item.' %}");
                  // Reset animation if failed
                  if (cartItemElem) {
                    cartItemElem.style.animation = '';
                  }
                }
              })
              .catch(() => {
                alertify.error("{% trans 'An error occurred. Please try again.' %}");
                if (cartItemElem) {
                  cartItemElem.style.animation = '';
                }
              });
            }, 400);
          },
          function() {
            alertify.message('{% trans "Action cancelled" %}');
          }
        );
      }
    });
  }

  // Add hover animations to cart items
  const cartItems = document.querySelectorAll('.modern-cart-item');
  cartItems.forEach(item => {
    item.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-5px)';
    });
    item.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
});
</script>
{% endblock %}
