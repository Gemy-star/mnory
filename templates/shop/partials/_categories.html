{% load i18n %}
{% if categories %}

<!-- Category Tabs Section -->
<section class="category-tabs-section">
    <div class="container">
        <!-- Section Header -->
        <div class="section-header-tabs" data-aos="fade-up">
            <h2 class="section-title-tabs">
                <span class="material-icons">category</span>
                {% trans "Shop by Category" %}
            </h2>
            <p class="section-subtitle-tabs">{% trans "Discover our curated collections" %}</p>
        </div>

        <!-- Category Tabs Navigation -->
        <div class="category-tabs-nav-wrapper" data-aos="fade-up" data-aos-delay="100">
            <div class="category-tabs-nav">
                <!-- All Categories Tab (Active by Default) -->
                <button class="category-tab-btn active" data-category="all" data-aos="zoom-in" data-aos-delay="150">
                    <span class="tab-icon">
                        <span class="material-icons">apps</span>
                    </span>
                    <span class="tab-label">{% trans "All" %}</span>
                    <span class="tab-indicator"></span>
                </button>

                {% for cat in categories %}
                <button class="category-tab-btn" data-category="{{ cat.slug }}" data-aos="zoom-in" data-aos-delay="{{ forloop.counter|add:150 }}">
                    <span class="tab-icon">
                        {% if cat.image %}
                            <img src="{{ cat.image.url }}" alt="{{ cat.name }}" class="tab-image">
                        {% else %}
                            <span class="material-icons">folder_open</span>
                        {% endif %}
                    </span>
                    <span class="tab-label">{{ cat.name }}</span>
                    <span class="tab-indicator"></span>
                </button>
                {% endfor %}
            </div>

            <!-- Navigation Arrows for Mobile -->
            <button class="tab-nav-arrow tab-nav-prev" aria-label="Previous">
                <span class="material-icons">chevron_left</span>
            </button>
            <button class="tab-nav-arrow tab-nav-next" aria-label="Next">
                <span class="material-icons">chevron_right</span>
            </button>
        </div>

        <!-- Products Grid Container -->
        <div class="category-products-container" data-aos="fade-up" data-aos-delay="200">
            <!-- Section Title -->
            <div class="category-products-header" data-aos="fade-up" data-aos-delay="250">
                <h3 class="category-products-title">
                    <span class="material-icons">inventory</span>
                    <span id="categoryTitle">{% trans "All Products" %}</span>
                </h3>
                <p class="category-products-subtitle" id="categorySubtitle">
                    {% trans "Discover our latest collection" %}
                </p>
            </div>

            <!-- Loading State -->
            <div class="products-loading" style="display: none;">
                <div class="loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                </div>
                <p class="loading-text">{% trans "Loading products..." %}</p>
            </div>

            <!-- Products Swiper Container -->
            <div class="category-products-swiper-container" id="categoryProductsSwiper" data-aos="fade-up" data-aos-delay="300">
                <div class="swiper">
                    <div class="swiper-wrapper" id="categoryProductsGrid">
                        <!-- Initial products loaded server-side -->
                        {% if initial_category_products %}
                            {% for product in initial_category_products %}
                                <div class="swiper-slide">
                                    {% include "partials/_product.html" with product=product %}
                                </div>
                            {% endfor %}
                        {% elif products %}
                            {% for product in products %}
                                <div class="swiper-slide">
                                    {% include "partials/_product.html" with product=product %}
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <!-- Swiper Pagination -->
                    <div class="swiper-pagination"></div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="products-empty" style="display: none;">
                <div class="empty-illustration">
                    <span class="material-icons empty-icon">inventory_2</span>
                    <div class="empty-rings">
                        <div class="ring ring-1"></div>
                        <div class="ring ring-2"></div>
                        <div class="ring ring-3"></div>
                    </div>
                </div>
                <h4 class="empty-title">{% trans "No products found" %}</h4>
                <p class="empty-message">{% trans "We couldn't find any products in this category" %}</p>
                <a href="{% url 'shop:category_detail' slug='all' %}" class="btn-view-all">
                    <span class="material-icons">search</span>
                    {% trans "Browse All Products" %}
                </a>
            </div>

            <!-- View All Button -->
            <div class="text-center mt-4" id="viewAllContainer" data-aos="fade-up" data-aos-delay="300">
                <a href="{% url 'shop:category_detail' slug='all' %}" id="viewAllLink" class="btn-view-all-category">
                    <span>{% trans "View All Products" %}</span>
                    <span class="material-icons">arrow_forward</span>
                </a>
            </div>
        </div>
    </div>
</section>

{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tabsNav = document.querySelector('.category-tabs-nav');
    const tabButtons = document.querySelectorAll('.category-tab-btn');
    const productsGrid = document.getElementById('categoryProductsGrid');
    const swiperContainer = document.getElementById('categoryProductsSwiper');
    const loadingState = document.querySelector('.products-loading');
    const emptyState = document.querySelector('.products-empty');
    const viewAllLink = document.getElementById('viewAllLink');
    const categoryTitle = document.getElementById('categoryTitle');
    const categorySubtitle = document.getElementById('categorySubtitle');
    const prevArrow = document.querySelector('.tab-nav-prev');
    const nextArrow = document.querySelector('.tab-nav-next');

    // Store cached products HTML by category
    let cachedProductsHTML = {};
    let currentCategory = 'all';
    let categorySwiper = null;

    // Initialize Category Products Swiper
    function initCategorySwiper() {
        if (typeof window.initCategoryProductsSwiper === 'function') {
            categorySwiper = window.initCategoryProductsSwiper();
        }
    }

    // Cache the initial server-rendered products
    const hasInitialProducts = productsGrid.children.length > 0;
    if (hasInitialProducts) {
        cachedProductsHTML['all'] = productsGrid.innerHTML;
        console.log('Cached initial products for "all" category');
        // Initialize swiper after initial products are loaded
        setTimeout(() => {
            initCategorySwiper();
        }, 100);
    }

    // Also cache initial products data for potential API usage
    let initialProductsData = [];
    try {
        initialProductsData = {% if initial_category_products_json %}{{ initial_category_products_json|safe }}{% else %}[]{% endif %};
        console.log('Initial products data loaded:', initialProductsData.length, 'products');
    } catch (e) {
        console.error('Error parsing initial products data:', e);
        initialProductsData = [];
    }

    // Initialize product interactions for server-rendered products
    initializeProductInteractions();

    // Show appropriate state on page load
    setTimeout(() => {
        if (productsGrid.children.length === 0) {
            console.warn('No products found, showing empty state');
            showEmptyState();
        } else {
            console.log('Products found:', productsGrid.children.length);
            showProducts();
            // Initialize swiper if not already done
            if (!categorySwiper) {
                initCategorySwiper();
            }
        }
    }, 100);

    // Tab Click Handler
    tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            const categoryName = this.querySelector('.tab-label').textContent;

            // Update active state
            tabButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Scroll tab into view
            this.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });

            // Update category title
            updateCategoryTitle(category, categoryName);

            // Update view all link
            const langPrefix = window.location.pathname.split('/')[1] || 'ar';
            const categorySlug = category === 'all' ? 'all' : category;
            viewAllLink.href = `/${langPrefix}/category/${categorySlug}/`;

            // Load products for this category
            if (category === 'all' && cachedProductsHTML['all']) {
                // Special handling for "All" category - use cached initial products
                console.log('Using cached initial products for "all" category');
                displayCachedProducts('all');
            } else if (cachedProductsHTML[category]) {
                // Use cached HTML for other categories
                console.log('Using cached products for:', category);
                displayCachedProducts(category);
            } else {
                // Load from server
                console.log('Loading products from server for:', category);
                loadProducts(category);
            }
        });
    });

    // Update Category Title
    function updateCategoryTitle(category, categoryName) {
        const titles = {
            'all': '{% trans "All Products" %}',
        };

        const subtitles = {
            'all': '{% trans "Discover our latest collection" %}',
        };

        categoryTitle.textContent = titles[category] || categoryName;
        categorySubtitle.textContent = subtitles[category] || `{% trans "Explore our" %} ${categoryName.toLowerCase()} {% trans "collection" %}`;
    }

    // Navigation Arrows
    if (prevArrow && nextArrow) {
        prevArrow.addEventListener('click', () => {
            tabsNav.scrollBy({ left: -200, behavior: 'smooth' });
        });

        nextArrow.addEventListener('click', () => {
            tabsNav.scrollBy({ left: 200, behavior: 'smooth' });
        });

        // Show/hide arrows based on scroll position
        function updateArrows() {
            const scrollLeft = tabsNav.scrollLeft;
            const maxScroll = tabsNav.scrollWidth - tabsNav.clientWidth;

            prevArrow.style.opacity = scrollLeft > 0 ? '1' : '0';
            prevArrow.style.pointerEvents = scrollLeft > 0 ? 'auto' : 'none';

            nextArrow.style.opacity = scrollLeft < maxScroll - 10 ? '1' : '0';
            nextArrow.style.pointerEvents = scrollLeft < maxScroll - 10 ? 'auto' : 'none';
        }

        tabsNav.addEventListener('scroll', updateArrows);
        window.addEventListener('resize', updateArrows);
        updateArrows();
    }

    // Display Cached Products
    function displayCachedProducts(category) {
        productsGrid.innerHTML = cachedProductsHTML[category];
        showProducts();

        // Refresh AOS animations
        if (typeof AOS !== 'undefined') {
            AOS.refresh();
        }

        // Re-initialize interactions
        initializeProductInteractions();

        // Destroy and reinitialize swiper
        if (categorySwiper) {
            categorySwiper.destroy(true, true);
        }
        setTimeout(() => {
            initCategorySwiper();
        }, 100);
    }

    // Load Products Function
    function loadProducts(category) {
        currentCategory = category;
        showLoading();

        // Get language prefix from current URL
        const langPrefix = window.location.pathname.split('/')[1] || 'ar';

        console.log('Loading products for category:', category, 'with language prefix:', langPrefix);

        // Try the correct API endpoint with language prefix
        fetch(`/${langPrefix}/api/products/?category=${category}`)
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Products loaded:', data);
                if (data.error) {
                    console.error('API Error:', data.error);
                    displayProductsJSON([]);
                } else {
                    // Cache the data and display
                    const products = data.products || data;
                    console.log('Processing', products.length, 'products');
                    displayProductsJSON(products, category);
                }
            })
            .catch(error => {
                console.error('Error loading products:', error);
                showEmptyState();
            });
    }

    // Display Products JSON
    function displayProductsJSON(products, category) {
        console.log('displayProductsJSON called with', products.length, 'products for category:', category);

        if (!products || products.length === 0) {
            showEmptyState();
        } else {
            productsGrid.innerHTML = '';

            products.forEach((product, index) => {
                console.log('Creating card for product:', product.name, 'with image:', product.image);

                // Create swiper slide wrapper
                const slide = document.createElement('div');
                slide.className = 'swiper-slide';

                // Create product card
                const productCard = createProductCard(product);

                // Append card to slide
                slide.appendChild(productCard);

                // Append slide to grid
                productsGrid.appendChild(slide);
            });

            // Cache the generated HTML
            cachedProductsHTML[category] = productsGrid.innerHTML;

            showProducts();

            // Refresh AOS
            if (typeof AOS !== 'undefined') {
                AOS.refresh();
            }

            // Initialize interactions
            initializeProductInteractions();

            // Destroy and reinitialize swiper
            if (categorySwiper) {
                categorySwiper.destroy(true, true);
            }
            setTimeout(() => {
                initCategorySwiper();
            }, 100);
        }
    }

    // Create Product Card from JSON
    function createProductCard(product) {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.setAttribute('data-product-id', product.id || product.pk);

        // Define translated strings (these will be processed by Django template engine)
        const translations = {
            out: '{% trans "Out" %}',
            sale: '{% trans "Sale" %}',
            best: '{% trans "Best" %}',
            new: '{% trans "New" %}',
            save: '{% trans "Save" %}',
            addToWishlist: '{% trans "Add to Wishlist" %}',
            addToCart: '{% trans "Add to Cart" %}',
            quickView: '{% trans "Quick View" %}'
        };

        // Product badges
        let badgesHtml = '<div class="product-badges">';
        if (!product.is_in_stock) {
            badgesHtml += `<div class="product-badge outofstock-badge"><i class="fas fa-times-circle"></i><span>${translations.out}</span></div>`;
        } else {
            if (product.is_on_sale) {
                const discountText = product.discount_percentage ? `-${product.discount_percentage}%` : '';
                badgesHtml += `<div class="product-badge sale-badge"><i class="fas fa-tag"></i><span>${translations.sale}</span>${discountText ? `<small>${discountText}</small>` : ''}</div>`;
            }
            if (product.is_best_seller) {
                badgesHtml += `<div class="product-badge bestseller-badge"><i class="fas fa-crown"></i><span>${translations.best}</span></div>`;
            }
            if (product.is_new_arrival) {
                badgesHtml += `<div class="product-badge new-badge"><i class="fas fa-sparkles"></i><span>${translations.new}</span></div>`;
            }
        }
        badgesHtml += '</div>';

        // Price HTML
        let priceHtml = '<div class="price-area">';
        if (product.is_on_sale && product.original_price) {
            priceHtml += '<div class="price-group">';
            priceHtml += `<span class="sale-price">${product.price}</span>`;
            priceHtml += `<span class="original-price">${product.original_price}</span>`;
            priceHtml += '</div>';
            if (product.discount_percentage) {
                priceHtml += `<div class="savings-badge">${translations.save} ${product.discount_percentage}%</div>`;
            }
        } else {
            priceHtml += `<span class="regular-price">${product.price}</span>`;
        }
        priceHtml += '</div>';

        // Wishlist state
        const wishlistIcon = product.in_wishlist ? 'fas fa-heart' : 'far fa-heart';
        const wishlistClass = product.in_wishlist ? 'active' : '';

        // Images - updated to match API field names
        const mainImage = product.image || '/static/img/placeholder.jpg';
        const hoverImage = product.hover_image || mainImage;

        console.log(`Product ${product.name}: main=${mainImage}, hover=${hoverImage}`);

        div.innerHTML = `
            <div class="position-relative product-image-wrapper">
                ${badgesHtml}
                <a href="${product.url || '#'}" class="product-link">
                    <img src="${mainImage}"
                         alt="${product.name}"
                         loading="lazy"
                         class="product-img">
                    ${hoverImage !== mainImage ? `
                    <img src="${hoverImage}"
                         alt="${product.name}"
                         loading="lazy"
                         class="product-img hover-switch-img">
                    ` : ''}
                </a>
                <div class="product-icons">
                    <button type="button"
                            class="wishlist-btn btn-icon-action ${wishlistClass}"
                            data-action="wishlist-toggle"
                            data-product-id="${product.id || product.pk}"
                            title="${translations.addToWishlist}">
                        <i class="${wishlistIcon}"></i>
                    </button>
                    <button type="button"
                            class="cart-btn btn-icon-action"
                            data-action="cart-add"
                            data-product-id="${product.id || product.pk}"
                            title="${translations.addToCart}">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                </div>
            </div>
            <div class="product-info mt-2">
                <div class="product-header">
                    <div class="product-name">
                        <a href="${product.url || '#'}" class="product-title-link">
                            ${product.name}
                        </a>
                    </div>
                    ${product.brand || product.category ? `
                    <div class="product-meta-info">
                        ${product.brand ? `<span class="product-brand">${product.brand}</span>` : ''}
                        ${product.category ? `<span class="product-category">${product.category}</span>` : ''}
                    </div>
                    ` : ''}
                </div>
                <div class="product-details-container">
                    ${priceHtml}
                    <div class="quick-actions">
                        <a href="${product.url || '#'}" class="btn-quick-view">
                            <i class="fas fa-eye"></i>
                            <span>${translations.quickView}</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="local-toast-container"></div>
        `;

        return div;
    }

    // Initialize Product Interactions
    function initializeProductInteractions() {
        // Wishlist buttons
        const wishlistBtns = productsGrid.querySelectorAll('.wishlist-btn[data-action="wishlist-toggle"]');
        wishlistBtns.forEach(btn => {
            // Remove old listeners by cloning
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (typeof handleWishlistToggle === 'function') {
                    handleWishlistToggle(this);
                }
            });
        });

        // Cart buttons
        const cartBtns = productsGrid.querySelectorAll('.cart-btn[data-action="cart-add"]');
        cartBtns.forEach(btn => {
            // Remove old listeners by cloning
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (typeof handleCartAdd === 'function') {
                    handleCartAdd(this);
                }
            });
        });
    }

    // State Management Functions
    function showLoading() {
        loadingState.style.display = 'flex';
        swiperContainer.style.display = 'none';
        emptyState.style.display = 'none';
    }

    function showProducts() {
        loadingState.style.display = 'none';
        swiperContainer.style.display = 'block';
        emptyState.style.display = 'none';
    }

    function showEmptyState() {
        loadingState.style.display = 'none';
        swiperContainer.style.display = 'none';
        emptyState.style.display = 'flex';
    }

    // Mobile Touch Scroll for Tabs
    let isDown = false;
    let startX;
    let scrollLeft;

    tabsNav.addEventListener('mousedown', (e) => {
        isDown = true;
        tabsNav.style.cursor = 'grabbing';
        startX = e.pageX - tabsNav.offsetLeft;
        scrollLeft = tabsNav.scrollLeft;
    });

    tabsNav.addEventListener('mouseleave', () => {
        isDown = false;
        tabsNav.style.cursor = 'grab';
    });

    tabsNav.addEventListener('mouseup', () => {
        isDown = false;
        tabsNav.style.cursor = 'grab';
    });

    tabsNav.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - tabsNav.offsetLeft;
        const walk = (x - startX) * 2;
        tabsNav.scrollLeft = scrollLeft - walk;
    });
});
</script>
