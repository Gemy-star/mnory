{% extends 'base.html' %}
{% load crispy_forms_tags i18n static %}

{% block title %}{{ product.name }} - {% trans "Mnory" %}{% endblock %}

{% block css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/css/glightbox.min.css">
<style>
    .glightbox-clean .gslide-image img {
        cursor: zoom-in;
    }
    .product-main-swiper img {
        cursor: pointer;
    }
    .glightbox-container {
        z-index: 9999 !important;
    }
</style>
{% endblock %}

{% block content %}
<main class="product-detail-page">
    <div class="container py-4 py-lg-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4" data-aos="fade-down">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'shop:home' %}">{% trans "Home" %}</a></li>
                <li class="breadcrumb-item"><a href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
            </ol>
        </nav>

        <div class="row g-4 g-lg-5">
            <!-- Product Gallery -->
            <div class="col-lg-6" data-aos="fade-right">
                <div class="product-gallery">
                    <div class="swiper product-main-swiper rounded border position-relative">
                        <div class="swiper-wrapper">
                            {% for image in product_images %}
                            <div class="swiper-slide">
                                <a href="{{ image.image.url }}" class="glightbox position-relative d-block" data-gallery="product-gallery" data-glightbox="title: {{ product.name }}; description: Image {{ forloop.counter }}">
                                    <img src="{{ image.image_resized.url }}" alt="{{ product.name }} image {{ forloop.counter }}" class="w-100 h-100 object-fit-contain">
                                    <div class="zoom-overlay position-absolute top-50 start-50 translate-middle">
                                        <i class="fas fa-search-plus fa-2x text-white"></i>
                                    </div>
                                </a>
                            </div>
                            {% empty %}
                            <div class="swiper-slide">
                                <img src="https://placehold.co/600x600/e0e0e0/555555?text=No+Image" alt="{% trans 'No image available' %}" class="w-100 h-100 object-fit-contain">
                            </div>
                            {% endfor %}
                        </div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                    <div class="swiper product-thumbs-swiper mt-2">
                        <div class="swiper-wrapper">
                            {% for image in product_images %}
                            <div class="swiper-slide">
                                <img src="{{ image.thumb_resized.url }}" alt="Thumbnail {{ forloop.counter }}" class="w-100 h-100 object-fit-cover rounded border">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-lg-6" data-aos="fade-left" data-aos-delay="100">
                <div class="product-info">
                    <h1 class="product-title h2 mb-3">{{ product.name }}</h1>

                    <div class="d-flex align-items-center mb-3">
                        <div class="product-price fs-3 fw-bold text-primary me-3">
                            <span id="display-price">
                                {% if currency == 'EGP' %}{{ product.price_egp_no_sale|floatformat:2 }} EGP{% else %}{{ product.price_usd_no_sale|floatformat:2 }} USD{% endif %}
                            </span>
                        </div>
                        {% if product.is_on_sale %}
                        <div class="product-price-original text-muted text-decoration-line-through">
                            <span>{% if currency == 'EGP' %}{{ product.price_egp|floatformat:2 }} EGP{% else %}{{ product.price_usd|floatformat:2 }} USD{% endif %}</span>
                            <span class="badge bg-danger ms-2">-{{ product.get_discount_percentage }}%</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if product.get_available_colors %}
                    <div class="mb-4">
                        <h6 class="fw-bold">{% trans "Color" %}</h6>
                        <div class="d-flex flex-wrap gap-2 color-buttons">
                            {% for color in product.get_available_colors %}
                            <button type="button" class="btn btn-outline-secondary color-select" data-color-id="{{ color.id }}" title="{{ color.name }}">
                                <span class="color-swatch" style="background-color: {{ color.hex_code }};"></span>
                                {{ color.name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="mb-4">
                        <h6 class="fw-bold">{% trans "Size" %}</h6>
                        <div class="d-flex flex-wrap gap-2 size-buttons">
                            <!-- Sizes will be populated by JS -->
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6 class="fw-bold">{% trans "Quantity" %}</h6>
                        <div class="quantity-selector d-flex align-items-center">
                            <button id="decrease-quantity" class="btn btn-outline-secondary" type="button">-</button>
                            <input type="text" id="quantity-input" class="form-control text-center mx-2" value="1" min="1" max="99" style="width: 60px;">
                            <button id="increase-quantity" class="btn btn-outline-secondary" type="button">+</button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="product-actions-wrapper mb-4">
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary btn-lg w-100 product-action-btn" id="add-to-cart-btn" {% if not product.is_in_stock %}disabled{% endif %}>
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    <span>{% trans "Add to Cart" %}</span>
                                </button>
                            </div>
                            <div class="col-md-6">
                                <form id="buy-now-form" action="{% url 'shop:buy_now' %}" method="post" class="h-100">
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ product.id }}">
                                    <input type="hidden" name="color_id" id="buy-now-color-id">
                                    <input type="hidden" name="size_id" id="buy-now-size-id">
                                    <input type="hidden" name="quantity" id="buy-now-quantity-input" value="1">
                                    <button type="submit" class="btn btn-success btn-lg w-100 product-action-btn" {% if not product.is_in_stock %}disabled{% endif %}>
                                        <i class="fas fa-bolt me-2"></i>
                                        <span>{% trans "Buy Now" %}</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        <button class="btn btn-outline-danger btn-lg w-100 product-action-btn wishlist-btn" id="add-to-wishlist-btn" data-product-id="{{ product.id }}">
                            <i class="far fa-heart me-2"></i>
                            <span id="wishlist-text">{% if is_in_wishlist %}{% trans "Remove from Wishlist" %}{% else %}{% trans "Add to Wishlist" %}{% endif %}</span>
                        </button>
                        <button class="btn btn-outline-info btn-lg w-100 product-action-btn compare-btn" data-action="compare-toggle" data-product-id="{{ product.id }}">
                            <i class="fas fa-exchange-alt me-2"></i>
                            <span>{% trans "Add to Compare" %}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Details Tabs -->
        <div class="mt-5" data-aos="fade-up">
            <ul class="nav nav-tabs" id="productTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">{% trans "Description" %}</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">{% trans "Reviews" %} ({{ product.review_count }})</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="size-chart-tab" data-bs-toggle="tab" data-bs-target="#size-chart" type="button" role="tab" aria-controls="size-chart" aria-selected="false">{% trans "Size Chart" %}</button>
                </li>
            </ul>
            <div class="tab-content pt-4" id="productTabContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                    {{ product.description|linebreaksbr }}
                </div>
                <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                    {% include 'shop/partials/_reviews.html' %}
                </div>
                <div class="tab-pane fade" id="size-chart" role="tabpanel" aria-labelledby="size-chart-tab">
                    {% if product.size_chart %}
                        {{ product.size_chart|safe }}
                    {% else %}
                        <p>{% trans "No size chart available for this product." %}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Related Products -->
        <section class="related-products-section mt-5" data-aos="fade-up">
            <h3 class="mb-4">{% trans "Related Products" %}</h3>
            <div class="swiper related-products-swiper">
                <div class="swiper-wrapper">
                    {% for related_product in related_products %}
                    <div class="swiper-slide">
                        {% include "partials/_product.html" with product=related_product %}
                    </div>
                    {% endfor %}
                </div>
                <div class="swiper-pagination"></div>
            </div>
        </section>
    </div>
</main>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/js/glightbox.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize GLightbox
    const lightbox = GLightbox({
        touchNavigation: true,
        loop: true,
        autoplayVideos: false,
        zoomable: true,
        draggable: true,
        closeButton: true,
        closeOnOutsideClick: true,
    });
    var thumbsSwiper = new Swiper('.product-thumbs-swiper', {
        spaceBetween: 10,
        slidesPerView: 4,
        freeMode: true,
        watchSlidesProgress: true,
    });

    var mainSwiper = new Swiper('.product-main-swiper', {
        spaceBetween: 10,
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        thumbs: {
            swiper: thumbsSwiper,
        },
    });

    var relatedSwiper = new Swiper('.related-products-swiper', {
        spaceBetween: 20,
        slidesPerView: 2,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
            dynamicBullets: true,
        },
        autoplay: {
            delay: 3500,
            disableOnInteraction: false,
            pauseOnMouseEnter: true,
        },
        breakpoints: {
            768: {
                slidesPerView: 3,
            },
            992: {
                slidesPerView: 4,
            },
        },
    });

    // --- Variant Selection Logic ---
    const colorButtons = document.querySelectorAll('.color-select');
    const sizeButtonsContainer = document.querySelector('.size-buttons');
    const buyNowColorIdInput = document.getElementById('buy-now-color-id');
    const buyNowSizeIdInput = document.getElementById('buy-now-size-id');
    let selectedColorId = null;
    let selectedSizeId = null;

    function fetchSizes(colorId) {
        const url = `/api/get-available-sizes/{{ product.id }}/?color_id=${colorId}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                sizeButtonsContainer.innerHTML = '';
                if (data.success && data.sizes.length > 0) {
                    data.sizes.forEach(size => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'btn btn-outline-secondary size-select';
                        button.dataset.sizeId = size.id;
                        button.textContent = size.name;
                        button.addEventListener('click', () => {
                            selectedSizeId = size.id;
                            buyNowSizeIdInput.value = selectedSizeId;
                            document.querySelectorAll('.size-select').forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                        });
                        sizeButtonsContainer.appendChild(button);
                    });
                } else {
                    sizeButtonsContainer.innerHTML = `<span class="text-muted">{% trans "No sizes available for this color." %}</span>`;
                }
            });
    }

    colorButtons.forEach(button => {
        button.addEventListener('click', () => {
            selectedColorId = button.dataset.colorId;
            buyNowColorIdInput.value = selectedColorId;
            colorButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            fetchSizes(selectedColorId);
        });
    });

    // --- Quantity Selector ---
    const decreaseBtn = document.getElementById('decrease-quantity');
    const increaseBtn = document.getElementById('increase-quantity');
    const quantityInput = document.getElementById('quantity-input');
    const buyNowQuantityInput = document.getElementById('buy-now-quantity-input');

    decreaseBtn.addEventListener('click', () => {
        let qty = parseInt(quantityInput.value);
        if (qty > 1) {
            quantityInput.value = qty - 1;
            buyNowQuantityInput.value = qty - 1;
        }
    });

    increaseBtn.addEventListener('click', () => {
        let qty = parseInt(quantityInput.value);
        quantityInput.value = qty + 1;
        buyNowQuantityInput.value = qty + 1;
    });

    // --- Add to Cart ---
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    addToCartBtn.addEventListener('click', () => {
        if (!selectedColorId || !selectedSizeId) {
            alert('{% trans "Please select a color and size." %}');
            return;
        }
        const quantity = parseInt(quantityInput.value);
        window.addToCart('{{ product.id }}', {
            quantity: quantity,
            colorId: selectedColorId,
            sizeId: selectedSizeId,
            button: addToCartBtn
        });
    });

    // --- Wishlist ---
    const wishlistBtn = document.getElementById('add-to-wishlist-btn');
    const wishlistText = document.getElementById('wishlist-text');
    wishlistBtn.addEventListener('click', () => {
        const productId = wishlistBtn.dataset.productId;
        window.toggleWishlist(productId, wishlistBtn);
    });
});
</script>
{% endblock %}
