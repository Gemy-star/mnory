{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Manage Products" %}{% endblock %}

{% block content %}
<main class="account-main">
    <div class="container py-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="breadcrumb-nav mb-4" data-aos="fade-down">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'shop:home' %}"><span class="material-icons">home</span> {% trans "Home" %}</a>
                </li>
                <li class="breadcrumb-item"><a href="{% url 'shop:vendor_dashboard' %}">{% trans "Dashboard" %}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{% trans "Manage Products" %}</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="dashboard-header mb-4" data-aos="fade-up">
            <h1 class="section-title mb-0">
                <span class="material-icons">inventory</span>
                {% trans "Manage Your Products" %}
            </h1>
            <a href="{% url 'shop:vendor_add_product' %}" class="btn btn-primary">
                <span class="material-icons">add</span> {% trans "Add New Product" %}
            </a>
        </div>

        <!-- Search and Filter Bar -->
        <div class="card mb-4" data-aos="fade-up" data-aos-delay="50">
            <div class="card-body">
                <form method="get" class="d-flex flex-wrap gap-3">
                    <div class="flex-grow-1">
                        <div class="input-group">
                            <span class="input-group-text"><span class="material-icons">search</span></span>
                            <input type="text" name="q" class="form-control" placeholder="{% trans 'Search by name or SKU...' %}" value="{{ search_query }}">
                        </div>
                    </div>
                    <div>
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="">{% trans "All Statuses" %}</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>{% trans "Active" %}</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>{% trans "Inactive" %}</option>
                        </select>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">{% trans "Filter" %}</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Products Table Card -->
        <div class="account-card" data-aos="fade-up" data-aos-delay="100">
            <div class="account-card-body">
                {% if products %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>{% trans "Product" %}</th>
                                <th>{% trans "SKU" %}</th>
                                <th>{% trans "Price" %}</th>
                                <th class="text-center">{% trans "Stock" %}</th>
                                <th class="text-center">{% trans "Status" %}</th>
                                <th class="text-end">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ product.get_main_image.image.url }}" alt="{{ product.name }}" class="product-image-sm me-3">
                                        <a href="{{ product.get_absolute_url }}" class="fw-bold text-decoration-none">{{ product.name|truncatechars:40 }}</a>
                                    </div>
                                </td>
                                <td>{{ product.sku|default:"N/A" }}</td>
                                <td class="fw-bold">{{ product.price|floatformat:2 }} EGP</td>
                                <td class="text-center">{{ product.stock_quantity }}</td>
                                <td class="text-center">
                                    {% if product.is_active %}
                                        <span class="badge bg-success">{% trans "Active" %}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{% trans "Inactive" %}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'shop:vendor_edit_product' product.id %}" class="btn btn-sm btn-outline-primary"><span class="material-icons">edit</span></a>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-product-btn" data-delete-url="{% url 'shop:vendor_delete_product' product.id %}"><span class="material-icons">delete</span></button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state-container text-center py-4">
                    <span class="material-icons empty-state-icon" style="font-size: 3rem;">inventory_2</span>
                    <h4 class="empty-state-title mt-3">{% trans "You haven't added any products yet." %}</h4>
                    <p class="empty-state-subtitle">{% trans "Start by adding your first product to your store." %}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Pagination -->
        {% if products.has_other_pages %}
        <nav aria-label="{% trans 'Page navigation' %}" class="pagination-wrapper mt-4" data-aos="fade-up">
            <ul class="pagination justify-content-center">
                {% if products.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ products.previous_page_number }}&q={{ search_query }}&status={{ status_filter }}" aria-label="{% trans 'Previous' %}">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for i in products.paginator.page_range %}
                {% if products.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ i }}&q={{ search_query }}&status={{ status_filter }}">{{ i }}</a></li>
                {% endif %}
                {% endfor %}

                {% if products.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ products.next_page_number }}&q={{ search_query }}&status={{ status_filter }}" aria-label="{% trans 'Next' %}">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteProductModalLabel">{% trans "Confirm Deletion" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% trans "Are you sure you want to delete this product? This action cannot be undone." %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">{% trans "Delete" %}</button>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteProductModal'));
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let productDeleteUrl = '';
    let rowToDelete = null;

    document.querySelectorAll('.delete-product-btn').forEach(button => {
        button.addEventListener('click', function() {
            productDeleteUrl = this.dataset.deleteUrl;
            rowToDelete = this.closest('tr');
            deleteModal.show();
        });
    });

    confirmDeleteBtn.addEventListener('click', async function() {
        if (!productDeleteUrl || !rowToDelete) return;

        const response = await fetch(productDeleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();
        if (data.success) {
            rowToDelete.style.transition = 'opacity 0.5s ease';
            rowToDelete.style.opacity = '0';
            setTimeout(() => rowToDelete.remove(), 500);
        } else {
            const message = data.message || '{% trans "An error occurred." %}';
            if (window.showToast) {
                window.showToast(message, 'error');
            } else if (typeof window.showNotification === 'function') {
                window.showNotification(message, 'error');
            } else {
                alert(message);
            }
        }
        deleteModal.hide();
    });
});
</script>
{% endblock %}
