{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}
    {{ subcategory.name }} - {{ category.name }} - My E-commerce Site
{% endblock %}


{% block content %}
<section class="subcategory-detail-section">
    <div class="container">
        <!-- Breadcrumb Navigation -->
        <nav class="breadcrumb-nav" aria-label="breadcrumb" data-aos="fade-down">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'shop:home' %}">
                        <span class="material-icons">home</span>
                        {% trans "Home" %}
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'shop:category_detail' slug=category.slug %}">{{ category.name }}</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">{{ subcategory.name }}</li>
            </ol>
        </nav>

        <!-- Subcategory Tabs Navigation -->
        <div class="subcategory-tabs-nav-wrapper" data-aos="fade-up" data-aos-delay="100">
            <div class="subcategory-tabs-nav">
                <a href="{% url 'shop:category_detail' slug=category.slug %}" class="subcategory-tab-btn {% if not current_filters.subcategory %}active{% endif %}">
                    <span class="material-icons">all_inclusive</span>
                    {% trans "All" %} {{ category.name }}
                </a>
                {% for subcat in subcategories %}
                <a href="{% url 'shop:subcategory_detail' category_slug=category.slug slug=subcat.slug %}" class="subcategory-tab-btn {% if current_filters.subcategory == subcat.slug %}active{% endif %}">
                    <span class="material-icons">label</span>
                    {{ subcat.name }}
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Horizontal Filters Bar (Collapsible on Mobile) -->
        <div class="horizontal-filters-collapsible" data-aos="fade-up" data-aos-delay="250">
            <button class="collapsible-toggle-btn" id="toggleFilters">
                <span class="material-icons">filter_alt</span>
                <span>{% trans "Filters" %}</span>
                <span class="material-icons toggle-arrow">expand_more</span>
            </button>
            <div class="horizontal-filters-wrapper collapsible-content" id="filtersPanel">
                <div class="horizontal-filters">
                    <!-- Filter Form -->
                    <form id="filter-form" class="horizontal-filters-form">
                        <input type="hidden" name="category_slug" value="{{ category.slug|default:'' }}">
                        <input type="hidden" name="subcategory_slug" value="{{ current_filters.subcategory|default:'' }}">
                        <!-- Filter Chips Container -->
                        <div class="filter-chips-container">
                            <!-- Sort Filter -->
                            <div class="filter-chip-group">
                                <span class="filter-chip-icon">
                                    <span class="material-icons">sort</span>
                                </span>
                                <select class="filter-chip-select" name="sort">
                                    <option value="">{% trans "Sort By" %}</option>
                                    <option value="name" {% if current_filters.sort == 'name' %}selected{% endif %}>{% trans "Name (A-Z)" %}</option>
                                    <option value="price_low" {% if current_filters.sort == 'price_low' %}selected{% endif %}>{% trans "Price (Low to High)" %}</option>
                                    <option value="price_high" {% if current_filters.sort == 'price_high' %}selected{% endif %}>{% trans "Price (High to Low)" %}</option>
                                    <option value="newest" {% if current_filters.sort == 'newest' %}selected{% endif %}>{% trans "Newest" %}</option>
                                    <option value="popular" {% if current_filters.sort == 'popular' %}selected{% endif %}>{% trans "Popular" %}</option>
                                </select>
                            </div>

                            <!-- Brand Filter -->
                            {% if brands %}
                            <div class="filter-chip-group">
                                <span class="filter-chip-icon">
                                    <span class="material-icons">sell</span>
                                </span>
                                <select class="filter-chip-select" name="brand">
                                    <option value="">{% trans "Brand" %}</option>
                                    {% for brand in brands %}
                                    <option value="{{ brand.slug }}" {% if brand.slug == current_filters.brand %}selected{% endif %}>{{ brand.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Fit Type Filter -->
                            {% if fit_types %}
                            <div class="filter-chip-group">
                                <span class="filter-chip-icon">
                                    <span class="material-icons">checkroom</span>
                                </span>
                                <select class="filter-chip-select" name="fit_type">
                                    <option value="">{% trans "Fit Type" %}</option>
                                    {% for fit_type in fit_types %}
                                    <option value="{{ fit_type.slug }}" {% if fit_type.slug == current_filters.fit_type %}selected{% endif %}>{{ fit_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Color Filter -->
                            {% if colors %}
                            <div class="filter-chip-group">
                                <span class="filter-chip-icon">
                                    <span class="material-icons">palette</span>
                                </span>
                                <select class="filter-chip-select" name="color">
                                    <option value="">{% trans "Color" %}</option>
                                    {% for color in colors %}
                                    <option value="{{ color.name }}" {% if color.name == current_filters.color %}selected{% endif %}>{{ color.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Size Filter -->
                            {% if sizes %}
                            <div class="filter-chip-group">
                                <span class="filter-chip-icon">
                                    <span class="material-icons">straighten</span>
                                </span>
                                <select class="filter-chip-select" name="size">
                                    <option value="">{% trans "Size" %}</option>
                                    {% for size in sizes %}
                                    <option value="{{ size.name }}" {% if size.name == current_filters.size %}selected{% endif %}>{{ size.name }} ({{ size.get_size_type_display }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Price Range Filter -->
                            <div class="filter-chip-group filter-price-group">
                                <span class="filter-chip-icon">
                                    <span class="material-icons">payments</span>
                                </span>
                                <input type="number" class="filter-price-input" name="min_price" placeholder="{% trans 'Min' %}" value="{{ current_filters.min_price|default:'' }}">
                                <span class="price-separator">â€”</span>
                                <input type="number" class="filter-price-input" name="max_price" placeholder="{% trans 'Max' %}" value="{{ current_filters.max_price|default:'' }}">
                            </div>

                            <!-- Special Flags -->
                            <div class="filter-chip-group filter-flags-group">
                                <button type="button" class="filter-flag-btn {% if current_filters.is_best_seller %}active{% endif %}" data-filter="is_best_seller">
                                    <span class="material-icons">stars</span>
                                    <span class="flag-label">{% trans "Best Seller" %}</span>
                                    <input type="checkbox" name="is_best_seller" value="true" {% if current_filters.is_best_seller %}checked{% endif %} hidden>
                                </button>
                                <button type="button" class="filter-flag-btn {% if current_filters.is_new_arrival %}active{% endif %}" data-filter="is_new_arrival">
                                    <span class="material-icons">new_releases</span>
                                    <span class="flag-label">{% trans "New" %}</span>
                                    <input type="checkbox" name="is_new_arrival" value="true" {% if current_filters.is_new_arrival %}checked{% endif %} hidden>
                                </button>
                                <button type="button" class="filter-flag-btn {% if current_filters.is_on_sale %}active{% endif %}" data-filter="is_on_sale">
                                    <span class="material-icons">local_offer</span>
                                    <span class="flag-label">{% trans "Sale" %}</span>
                                    <input type="checkbox" name="is_on_sale" value="true" {% if current_filters.is_on_sale %}checked{% endif %} hidden>
                                </button>
                            </div>

                            <!-- Clear Filters Button -->
                            <button type="button" class="filter-clear-btn" id="clearFiltersBtn">
                                <span class="material-icons">clear</span>
                                <span>{% trans "Clear All" %}</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="subcategory-products-section" data-aos="fade-up" data-aos-delay="300">
            <!-- Products Header: left=title/count, right=controls -->
            <div class="products-header">
                <div class="products-header-left">
                    <h2 class="products-title">
                        <span class="material-icons">inventory</span>
                        {{ subcategory.name }}
                    </h2>
                    <p class="products-count" aria-live="polite">
                        {% if products %}
                            <span id="productsCount">{{ products.paginator.count }}</span> {% trans "products found" %}
                        {% endif %}
                    </p>
                </div>

                <div class="products-header-right">
                    <div class="view-controls" role="toolbar" aria-label="View controls">
                        <button type="button" class="view-btn view-grid active" aria-pressed="true" title="Grid view">
                            <span class="material-icons">grid_view</span>
                        </button>
                        <button type="button" class="view-btn view-list" aria-pressed="false" title="List view">
                            <span class="material-icons">view_list</span>
                        </button>
                    </div>

                    <div class="per-page-control">
                        <label for="perPageSelect" class="sr-only">{% trans "Items per page" %}</label>
                        <select id="perPageSelect" class="per-page-select">
                            <option value="12" {% if request.GET.per_page == '12' %}selected{% endif %}>12</option>
                            <option value="24" {% if request.GET.per_page == '24' %}selected{% endif %}>24</option>
                            <option value="48" {% if request.GET.per_page == '48' %}selected{% endif %}>48</option>
                        </select>
                    </div>

                    <!-- Mobile filters quick-open -->
                    <button id="openFiltersMobile" class="btn btn-outline filters-open-mobile" aria-hidden="true" title="{% trans 'Filters' %}">
                        <span class="material-icons">filter_alt</span>
                    </button>
                </div>
            </div>

            <!-- Loading placeholder (used by JS when refetching) -->
            <div id="productsLoading" class="products-loading" aria-hidden="true" style="display:none">
                <div class="loading-spinner"></div>
            </div>

            <!-- Products Grid -->
            <div id="product-list-container" class="products-grid" role="list">
                {% for product in products %}
                    <div class="product-card-wrapper" data-aos="fade-up" data-aos-delay="{{ forloop.counter|add:50 }}" role="listitem">
                        {% include "partials/_product.html" with product=product section="sub_category" %}
                    </div>
                {% empty %}
                    <div class="empty-products-state">
                        <div class="empty-illustration">
                            <span class="material-icons empty-icon">inventory_2</span>
                        </div>
                        <h4 class="empty-title">{% trans "No products found" %}</h4>
                        <p class="empty-message">{% trans "No products found in this subcategory or with the selected filters." %}</p>
                        <div class="empty-actions">
                            <a href="{% url 'shop:home' %}" class="btn-back-home btn btn-primary">
                                <span class="material-icons">home</span>
                                {% trans "Back to Home" %}
                            </a>
                            <a href="{% url 'shop:home' %}?sort=popular" class="btn-suggest btn btn-outline">
                                <span class="material-icons">star</span>
                                {% trans "View popular products" %}
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if products.has_other_pages %}
            <div class="pagination-wrapper">
                <nav aria-label="{% trans 'Page navigation' %}" class="pagination-nav">
                    <ul class="pagination">
                        {% if products.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ products.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <span class="material-icons">chevron_left</span>
                                    {% trans "Previous" %}
                                </a>
                            </li>
                        {% endif %}

                        {% for i in products.paginator.page_range %}
                            {% if products.number == i %}
                                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if products.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ products.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {% trans "Next" %}
                                    <span class="material-icons">chevron_right</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}


{% block js %}
<script>
    $(document).ready(function() {
        // Function to update URL parameters and reload page
        function updateUrlAndReload() {
            const currentUrl = new URL(window.location.href);
            const params = new URLSearchParams(currentUrl.search);

            // Clear existing filter parameters to avoid duplication
            params.delete('fit_type');
            params.delete('brand');
            params.delete('color');
            params.delete('size');
            params.delete('min_price');
            params.delete('max_price');
            params.delete('sort');
            params.delete('is_best_seller');
            params.delete('is_new_arrival');
            params.delete('is_on_sale');
            params.delete('page'); // Reset page on filter change

            // Add selected filters from checkboxes and select
            $('#filter-form').find('input[type="checkbox"]:checked, select').each(function() {
                const name = $(this).attr('name');
                const value = $(this).val();
                if (name && value) {
                    params.append(name, value);
                }
            });

            // Add price range inputs
            const minPrice = $('input[name="min_price"]').val();
            const maxPrice = $('input[name="max_price"]').val();
            if (minPrice) params.set('min_price', minPrice);
            if (maxPrice) params.set('max_price', maxPrice);

            // Reconstruct the URL
            currentUrl.search = params.toString();
            window.location.href = currentUrl.toString();
        }

        // Event listeners for filter changes
        $('#filter-form input[type="checkbox"], #filter-form select').on('change', function() {
            updateUrlAndReload();
        });

        // Event listener for price range apply button
        $('#filter-form button[type="submit"]').on('click', function(e) {
            e.preventDefault(); // Prevent default form submission
            updateUrlAndReload();
        });
    });
</script>
{% endblock js  %}



