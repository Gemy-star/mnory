{% extends "base.html" %}
{% load i18n crispy_forms_tags %}
{% load static %}
{% block title %}{% trans "Checkout" %}{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock css %}

{% block content %}
<main class="checkout-main">
    <div class="container py-5">
        <!-- Page Header -->
        <div class="modern-cart-header" data-aos="fade-down">
            <div class="cart-header-content">
                <div class="cart-icon-wrapper">
                    <span class="material-icons cart-icon">shopping_cart_checkout</span>
                </div>
                <h1 class="cart-title">{% trans "Secure Checkout" %}</h1>
                <p class="cart-subtitle">{% trans "Almost there! Please complete your order." %}</p>
            </div>
            <div class="cart-divider"></div>
        </div>

        <form id="checkout-form" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="checkout-layout" data-aos="fade-up" data-aos-delay="100">
                <!-- Left Column: Shipping & Payment -->
                <div class="checkout-main-column">
                    <!-- Shipping Address Section -->
                    <div class="checkout-section-card" data-aos="fade-right" data-aos-delay="200">
                        <h2 class="checkout-section-title">
                            <span class="material-icons">local_shipping</span>
                            {% trans "Shipping Information" %}
                        </h2>
                        <div class="checkout-section-body">
                            {% if user_shipping_addresses %}
                            <div class="mb-4">
                                <label class="form-label fw-bold">{% trans "Select a saved address:" %}</label>
                                <div class="saved-addresses-list">
                                    {% for address in user_shipping_addresses %}
                                    <div class="form-check saved-address-item">
                                        <input class="form-check-input" type="radio" name="saved_address" id="address-{{ address.id }}" value="{{ address.id }}" data-city="{{ address.city }}" {% if forloop.first %}checked{% endif %}>
                                        <label class="form-check-label" for="address-{{ address.id }}">
                                            <span class="material-icons address-icon">location_on</span>
                                            <div class="address-details">
                                                <strong>{{ address.full_name }}</strong><br>
                                                {{ address.address_line1 }}, {{ address.city }}
                                            </div>
                                        </label>
                                    </div>
                                    {% endfor %}
                                    <div class="form-check mt-2 saved-address-item">
                                        <input class="form-check-input" type="radio" name="saved_address" id="new-address" value="new">
                                        <label class="form-check-label" for="new-address">
                                            <span class="material-icons address-icon">add_location_alt</span>
                                            {% trans "Use a new address" %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div id="shipping-form-container" class="{% if user_shipping_addresses %}d-none{% endif %}">
                                {{ shipping_form|crispy }}
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method Section -->
                    <div class="checkout-section-card mt-4" data-aos="fade-right" data-aos-delay="300">
                        <h2 class="checkout-section-title">
                            <span class="material-icons">payments</span>
                            {% trans "Payment Method" %}
                        </h2>
                        <div class="checkout-section-body">
                            <div class="payment-option">
                                <input type="radio" id="cod" name="payment_method" value="cod" checked class="form-check-input">
                                <label for="cod" class="form-check-label">
                                    <span class="material-icons">payments</span>
                                    {% trans "Cash on Delivery" %}
                                </label>
                                <p class="payment-description">{% trans "Pay with cash upon delivery." %}</p>
                            </div>

                            <div class="payment-option">
                                <input type="radio" id="offline_payment" name="payment_method" value="offline_payment" class="form-check-input">
                                <label for="offline_payment" class="form-check-label">
                                    <span class="material-icons">account_balance</span>
                                    {% trans "Offline Payment (Instagram/Bank Transfer)" %}
                                </label>
                                <p class="payment-description">{% trans "Transfer via Instagram or bank and upload proof." %}</p>
                            </div>

                            <!-- Offline Payment Details (Initially Hidden) -->
                            <div id="offline-payment-details" class="mt-3 p-3 border rounded bg-light" style="display: none;">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "Payment Instructions" %}
                                </h6>

                                {% load constance_tags %}
                                <div class="alert alert-info">
                                    {% get_config 'OFFLINE_PAYMENT_INSTRUCTIONS' as instructions %}
                                    {{ instructions }}
                                </div>

                                <!-- Instagram QR Code -->
                                {% get_config 'INSTAGRAM_QR_CODE' as qr_code %}
                                {% if qr_code %}
                                <div class="text-center mb-3">
                                    <h6 class="mb-2">{% trans "Scan QR Code to Pay via Instagram" %}</h6>
                                    <img src="{{ MEDIA_URL }}{{ qr_code }}" alt="Instagram QR Code" class="img-fluid" style="max-width: 250px;">
                                    <p class="small text-muted mt-2">
                                        {% get_config 'INSTAGRAM_URL' as instagram_url %}
                                        <a href="{{ instagram_url }}" target="_blank" class="text-decoration-none">
                                            <i class="fab fa-instagram me-1"></i>Visit our Instagram
                                        </a>
                                    </p>
                                </div>
                                {% endif %}

                                <!-- Bank Details -->
                                {% get_config 'BANK_NAME' as bank_name %}
                                {% get_config 'BANK_ACCOUNT_NUMBER' as bank_account %}
                                {% if bank_name and bank_account %}
                                <div class="mb-3">
                                    <h6 class="mb-2">{% trans "Bank Transfer Details" %}</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <p class="mb-1"><strong>{% trans "Bank Name:" %}</strong> {{ bank_name }}</p>
                                            <p class="mb-0"><strong>{% trans "Account Number:" %}</strong> <code>{{ bank_account }}</code></p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Transaction Photo Upload -->
                                <div class="mb-3">
                                    <label for="transaction_photo" class="form-label fw-bold">
                                        <i class="fas fa-upload me-2"></i>{% trans "Upload Transaction Screenshot" %} <span class="text-danger">*</span>
                                    </label>
                                    <input type="file"
                                           class="form-control"
                                           id="transaction_photo"
                                           name="transaction_photo"
                                           accept="image/*"
                                           required>
                                    <small class="form-text text-muted">
                                        {% trans "Please upload a clear screenshot of your payment transaction." %}
                                    </small>
                                    <div class="invalid-feedback">
                                        {% trans "Transaction proof is required for offline payments." %}
                                    </div>
                                </div>

                                <!-- Preview -->
                                <div id="photo-preview" class="mt-2" style="display: none;">
                                    <p class="small mb-1">{% trans "Preview:" %}</p>
                                    <img id="preview-image" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Order Summary -->
                <div class="checkout-summary-column">
                    <div class="modern-order-summary sticky-summary" data-aos="fade-left" data-aos-delay="400">
                        <div class="summary-header">
                            <span class="material-icons summary-icon">receipt_long</span>
                            <h3 class="summary-title">{% trans "Order Summary" %}</h3>
                        </div>

                        <div class="summary-body">
                            <ul class="summary-item-list">
                                {% for item in cart_items %}
                                <li class="summary-item">
                                    <img src="{{ item.product_variant.product.get_main_image.image.url }}" alt="{{ item.product_variant.product.name }}" class="summary-item-image">
                                    <div class="summary-item-details">
                                        <span class="summary-item-name">{{ item.product_variant.product.name }}</span>
                                        <span class="summary-item-variant">{{ item.product_variant.color.name }}, {{ item.product_variant.size.name }}</span>
                                    </div>
                                    <div class="summary-item-pricing">
                                        <span class="summary-item-qty">x{{ item.quantity }}</span>
                                        <span class="summary-item-total">{{ item.get_total_price|floatformat:2 }} EGP</span>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>

                            <div class="summary-divider"></div>

                            <div class="summary-line">
                                <span class="summary-label"><span class="label-icon material-icons">shopping_cart</span>{% trans "Subtotal" %}</span>
                                <span class="summary-value" id="summary-subtotal">{{ subtotal|floatformat:2 }} EGP</span>
                            </div>
                            <div class="summary-line">
                                <span class="summary-label"><span class="label-icon material-icons">local_shipping</span>{% trans "Shipping" %}</span>
                                <span class="summary-value" id="summary-shipping">{{ shipping_fee|floatformat:2 }} EGP</span>
                            </div>
                            {% if discount_amount > 0 %}
                            <div class="summary-line text-success">
                                <span class="summary-label"><span class="label-icon material-icons text-success">check_circle</span>{% trans "Discount" %}</span>
                                <span class="summary-value" id="summary-discount">-{{ discount_amount|floatformat:2 }} EGP</span>
                            </div>
                            {% endif %}
                            <div class="summary-divider"></div>
                            <div class="summary-line summary-total">
                                <strong class="summary-label-total">{% trans "Grand Total" %}</strong>
                                <strong class="summary-value-total" id="summary-grand-total">{{ grand_total|floatformat:2 }} EGP</strong>
                            </div>
                        </div>

                        <div class="summary-footer">
                            <button type="submit" class="modern-checkout-btn">
                <span class="material-icons">shopping_cart_checkout</span>
                                {% trans "Place Order" %}
                            </button>
                            <a href="{% url 'shop:cart_view' %}" class="continue-shopping-link">
                                <span class="material-icons">arrow_back</span>
                                {% trans "Back to Cart" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    AOS.init({
        duration: 800,
        easing: 'ease-out-cubic',
        once: true,
        offset: 50
    });

    // Handle offline payment details toggle
    const offlinePaymentRadio = document.getElementById('offline_payment');
    const codRadio = document.getElementById('cod');
    const offlineDetails = document.getElementById('offline-payment-details');
    const transactionPhotoInput = document.getElementById('transaction_photo');
    const photoPreview = document.getElementById('photo-preview');
    const previewImage = document.getElementById('preview-image');

    function toggleOfflinePaymentDetails() {
        if (offlinePaymentRadio && offlinePaymentRadio.checked) {
            offlineDetails.style.display = 'block';
            transactionPhotoInput.setAttribute('required', 'required');
        } else {
            offlineDetails.style.display = 'none';
            transactionPhotoInput.removeAttribute('required');
            transactionPhotoInput.value = '';
            photoPreview.style.display = 'none';
        }
    }

    if (offlinePaymentRadio) {
        offlinePaymentRadio.addEventListener('change', toggleOfflinePaymentDetails);
    }
    if (codRadio) {
        codRadio.addEventListener('change', toggleOfflinePaymentDetails);
    }

    // Handle file preview
    if (transactionPhotoInput) {
        transactionPhotoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    photoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                photoPreview.style.display = 'none';
            }
        });
    }

    // Form validation for offline payment
    const checkoutForm = document.querySelector('form');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            if (offlinePaymentRadio && offlinePaymentRadio.checked) {
                if (!transactionPhotoInput.files || transactionPhotoInput.files.length === 0) {
                    e.preventDefault();
                    transactionPhotoInput.classList.add('is-invalid');
                    alert('{% trans "Please upload a transaction screenshot for offline payment." %}');
                    return false;
                }
                transactionPhotoInput.classList.remove('is-invalid');
            }
        });
    }

    const cityField = document.getElementById('id_city');
    const shippingCostEl = document.getElementById('summary-shipping');
    const grandTotalEl = document.getElementById('summary-grand-total');
    const subtotal = parseFloat('{{ subtotal|floatformat:2 }}');
    const discount = parseFloat('{{ discount_amount|floatformat:2 }}');

    if (cityField) {
        cityField.addEventListener('change', async function() {
            const city = this.value;
            if (!city) return;

            try {
                const response = await fetch(`{% url 'shop:get_shipping_cost' %}?city=${city}`);
                const data = await response.json();

                if (data.shipping_cost !== undefined) {
                    const shippingCost = parseFloat(data.shipping_cost);
                    shippingCostEl.textContent = `${shippingCost.toFixed(2)} EGP`;
                    grandTotalEl.textContent = `${(subtotal + shippingCost - discount).toFixed(2)} EGP`;
                }
            } catch (error) {
                console.error('Error fetching shipping cost:', error);
            }
        });
    }

    const savedAddressRadios = document.querySelectorAll('input[name="saved_address"]');
    const shippingFormContainer = document.getElementById('shipping-form-container');

    if (savedAddressRadios.length > 0 && shippingFormContainer) {
        savedAddressRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'new') {
                    shippingFormContainer.classList.remove('d-none');
                    // Trigger change on city field to recalculate shipping if it has a value
                    if(cityField.value) cityField.dispatchEvent(new Event('change'));
                } else {
                    shippingFormContainer.classList.add('d-none');
                    // When a saved address is selected, get its city and update shipping
                    const selectedRadio = document.querySelector('input[name="saved_address"]:checked');
                    if (selectedRadio && selectedRadio.dataset.city) {
                        const city = selectedRadio.dataset.city;
                        // Simulate a change event on a temporary element to trigger the fetch
                        const tempSelect = document.createElement('select');
                        tempSelect.value = city;
                        cityField.value = city; // Keep the hidden form in sync
                        cityField.dispatchEvent(new Event('change'));
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}
